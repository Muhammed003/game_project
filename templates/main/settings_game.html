{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Настройки — Игра</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #f3f8ff, #e6f0ff);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    .settings-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(11,36,83,0.12);
      padding: 24px;
      max-width: 400px;
      width: 100%;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .settings-card h2 {
      margin: 0;
      font-size: 24px;
      color: #08386b;
      text-align: center;
    }

    .settings-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .settings-section strong {
      color: #06406b;
    }

    .btn-settings {
      background: #2b8cff;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-settings:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(11,36,83,0.2);
    }

    .difficulty-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .difficulty-buttons button {
      flex: 1;
      min-width: 80px;
      background: #eef6ff;
      border: 1px solid #d7eaff;
      border-radius: 10px;
      padding: 6px 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .difficulty-buttons button.active {
      background: linear-gradient(180deg,#2b8cff,#1a6fe0);
      color: #fff;
      border: none;
    }

    .difficulty-buttons button:hover {
      opacity: 0.85;
    }

    .flags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
    }

    .flags img {
      width: 64px;
      height: 48px;
      border-radius: 4px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .flags img:hover {
      transform: scale(1.1);
    }

    @media(max-width: 480px) {
      .settings-card {
        padding: 16px;
      }
      .difficulty-buttons button {
        min-width: 60px;
        font-size: 12px;
      }
      .flags img {
        width: 56px;
        height: 40px;
      }
    }
  </style>
</head>
<body>

<div class="settings-card" id="notLogged" style="display:none;">
  <h2>Настройки</h2>
  <div class="settings-section">
    <button class="btn-settings" onclick="window.location.href='{% url  'login' %}'">Войти</button>
  </div>
</div>

<div class="settings-card" id="logged" style="display:none;">
  <h2>Настройки</h2>

  <div class="settings-section">
    <strong>Профиль:</strong>
    <div>{{ request.user.username }}</div>
  </div>

  <div class="settings-section">
    <strong>Рейтинг:</strong>
    <div>{{ request.user.rating|default:'0' }}</div>
  </div>

  <div class="settings-section">
    <strong>Звук:</strong>
    <label class="form-check-label">
      <input type="checkbox" class="form-check-input" id="soundToggle" checked> Включить звук
    </label>
  </div>

  <div class="settings-section">
    <strong>Уровень сложности:</strong>
    <div class="difficulty-buttons">
      <button class="btn" onclick="setDifficulty('easy')">Лёгкая</button>
      <button class="btn" onclick="setDifficulty('normal')">Нормальная</button>
      <button class="btn" onclick="setDifficulty('hard')">Сложная</button>
    </div>
  </div>

      <div class="flags" id="flagsWrap">
          {% for c in countries %}
            {% if c.flag %}
              <img src="{{ c.flag }}" alt="{{ c.name }}" title="{{ c.name }}" class="flag-item"
                   data-country-name="{{ c.name }}">
            {% else %}
              <button class="flag-item no-flag" data-country-name="{{ c.name }}">{{ c.name }}</button>
            {% endif %}
          {% endfor %}
        </div>

</div>
<!-- Модал для ввода кода доступа -->
<div id="codeModal" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; background: rgba(0,0,0,0.45); z-index:2000;">
  <div style="width:320px; max-width:92%; background:#fff; border-radius:12px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.25);">
    <h3 style="margin:0 0 8px;">Введите код доступа</h3>
    <p id="modalCountryName" style="margin:0 0 12px; color:#556"></p>
    <input id="accessCodeInput" type="password" placeholder="Код" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e6eefc; margin-bottom:10px;" />
    <div style="display:flex; gap:8px;">
      <button id="submitCodeBtn" class="btn-settings" style="flex:1">Проверить</button>
      <button id="cancelCodeBtn" class="btn" style="flex:1">Отмена</button>
    </div>
    <p id="codeError" style="color:#c00; margin-top:10px; min-height:20px"></p>
  </div>
</div>
<script>
  const loggedIn = {{ request.user.is_authenticated|yesno:"true,false" }};
  document.getElementById('logged').style.display = loggedIn ? 'flex' : 'none';
  document.getElementById('notLogged').style.display = loggedIn ? 'none' : 'flex';

  function setDifficulty(level){
    console.log('Выбрана сложность:', level);
    const buttons = document.querySelectorAll('.difficulty-buttons button');
    buttons.forEach(b => b.classList.toggle('active', b.textContent === level));
  }

  function selectCountry(name){
    console.log('Выбрана страна:', name);
  }

  document.getElementById('soundToggle')?.addEventListener('change', e => {
    console.log('Звук:', e.target.checked);
  });
</script>
<script>
  // CSRF helper (standard Django)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  const flagsWrap = document.getElementById('flagsWrap');
  const modal = document.getElementById('codeModal');
  const modalCountryName = document.getElementById('modalCountryName');
  const accessInput = document.getElementById('accessCodeInput');
  const submitBtn = document.getElementById('submitCodeBtn');
  const cancelBtn = document.getElementById('cancelCodeBtn');
  const codeError = document.getElementById('codeError');

  let currentCountry = null;

  // клик по флагу — откроем модал
  document.querySelectorAll('.flag-item').forEach(el=>{
    el.addEventListener('click', ()=>{
      currentCountry = el.dataset.countryName;
      modalCountryName.textContent = 'Страна: ' + currentCountry;
      accessInput.value = '';
      codeError.textContent = '';
      modal.style.display = 'flex';
      accessInput.focus();
    });
  });

  cancelBtn.addEventListener('click', ()=>{ modal.style.display = 'none'; });

  submitBtn.addEventListener('click', async ()=>{
    const code = accessInput.value.trim();
    if(!code){ codeError.textContent = 'Введите код доступа'; return; }
    submitBtn.disabled = true;
    codeError.textContent = 'Проверка...';

    try {
      const form = new FormData();
      form.append('country', currentCountry);
      form.append('code', code);

      const resp = await fetch("{% url 'verify_country_code' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken },
        body: form,
        credentials: 'same-origin',
      });

      const data = await resp.json();
      if(resp.ok && data.ok){
        // успешно — перенаправляем на home (сервер возвращает относительный URL)
        window.location.href = data.redirect || '/';
      } else {
        submitBtn.disabled = false;
        if(data && data.error === 'wrong_code'){
          codeError.textContent = 'Неверный код';
        } else if(data && data.error === 'no_country'){
          codeError.textContent = 'Страна не найдена';
        } else {
          codeError.textContent = 'Ошибка проверки';
        }
      }
    } catch(err){
      submitBtn.disabled = false;
      codeError.textContent = 'Ошибка сети';
    }
  });

  // enter key
  accessInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') submitBtn.click(); });

  // закрыть модал кликом вне окна (необязательно)
  modal.addEventListener('click', (e)=>{ if(e.target === modal) modal.style.display = 'none'; });
</script>
</body>
</html>
