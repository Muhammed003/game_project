{% extends '../../main/base.html' %}
{% load static %}

{% block content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{background:#f0f2f5;font-family:Poppins,sans-serif}
.player-container{display:flex;flex-direction:column;gap:20px}
@media(min-width:768px){.player-container{flex-direction:row}}
.track-list{flex:1;max-height:500px;overflow-y:auto;background:#fff;border-radius:10px;padding:15px}
.track-item{cursor:pointer;padding:10px;border-bottom:1px solid #eee}
.track-item.active{background:#6c63ff;color:#fff;font-weight:bold}
.audio-player{flex:2;padding:20px;background:#fff;border-radius:15px}
.progress{height:8px;background:#ddd;border-radius:5px}
.progress-bar{background:#6c63ff}
.btn-circle{width:60px;height:60px;border-radius:50%}
</style>

<div class="container my-5 player-container">

    <div class="track-list">
        <h5>Список треков</h5>
        <div id="tracksContainer"></div>
    </div>

    <div class="audio-player">
        <div id="nowPlaying" class="text-center fw-bold mb-3">Выберите трек</div>

        <div class="progress mb-2">
            <div class="progress-bar" style="width:0%"></div>
        </div>

        <div class="d-flex justify-content-between mb-3">
            <span id="currentTime">0:00</span>
            <span id="duration">0:00</span>
        </div>

        <div class="d-flex justify-content-center gap-3">
            <button id="prevBtn" class="btn btn-secondary btn-circle">
                <i class="fas fa-backward"></i>
            </button>
            <button id="playBtn" class="btn btn-primary btn-circle">
                <i class="fas fa-play"></i>
            </button>
            <button id="nextBtn" class="btn btn-secondary btn-circle">
                <i class="fas fa-forward"></i>
            </button>
        </div>
    </div>
</div>

<!-- ВАЖНО: audio в DOM -->
<audio id="audio"></audio>

<script>
const isMobile = /iPhone|iPad|Android/i.test(navigator.userAgent);

const tracks = [
{% for track in tracks %}
{number:{{track.number_of_name}},title:"{{track.title|escapejs}}",artist:"{{track.author|escapejs}}",url:"{{track.file.url}}"},
{% endfor %}
].sort((a,b)=>a.number-b.number);

const audio = document.getElementById("audio");
audio.preload = isMobile ? "none" : "metadata";

const tracksContainer = document.getElementById("tracksContainer");
const nowPlaying = document.getElementById("nowPlaying");
const playBtn = document.getElementById("playBtn");
const progressBar = document.querySelector(".progress-bar");
const currentTimeEl = document.getElementById("currentTime");
const durationEl = document.getElementById("duration");

let current = -1;
let lastUpdate = 0;

/* render list */
tracks.forEach((t,i)=>{
    const d=document.createElement("div");
    d.className="track-item";
    d.textContent=`${t.number}. ${t.title}`;
    d.onclick=()=>loadTrack(i,true);
    tracksContainer.appendChild(d);
});

function setActive(){
    document.querySelectorAll(".track-item")
        .forEach((el,i)=>el.classList.toggle("active",i===current));
}

function loadTrack(i,play=false){
    if(current===i && play){audio.play();return;}
    current=i;
    audio.src=tracks[i].url;
    audio.load();
    setActive();
    nowPlaying.textContent=`${tracks[i].title} — ${tracks[i].artist}`;
    if(play){audio.play();playBtn.innerHTML='<i class="fas fa-pause"></i>';}
}

/* controls */
playBtn.onclick=()=>{
    if(current===-1)return;
    if(audio.paused){audio.play();playBtn.innerHTML='<i class="fas fa-pause"></i>';}
    else{audio.pause();playBtn.innerHTML='<i class="fas fa-play"></i>';}
};

document.getElementById("prevBtn").onclick=()=>loadTrack((current-1+tracks.length)%tracks.length,true);
document.getElementById("nextBtn").onclick=()=>loadTrack((current+1)%tracks.length,true);

/* throttled progress */
audio.addEventListener("timeupdate",()=>{
    const now=Date.now();
    if(now-lastUpdate<500)return;
    lastUpdate=now;

    if(!audio.duration)return;
    const p=(audio.currentTime/audio.duration)*100;
    progressBar.style.width=p+"%";
    currentTimeEl.textContent=format(audio.currentTime);
    durationEl.textContent=format(audio.duration);
});

audio.addEventListener("ended",()=>loadTrack((current+1)%tracks.length,true));

function format(s){
    if(!s||isNaN(s))return"0:00";
    return Math.floor(s/60)+":"+String(Math.floor(s%60)).padStart(2,"0");
}
</script>

{% endblock %}
